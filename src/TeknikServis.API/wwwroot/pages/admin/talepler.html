<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kayƒ±t Talepleri - Teknik Servis</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/responsive.css">
</head>
<body>
    <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">‚öôÔ∏è</div>
                    <h2>Y√∂netim Paneli</h2>
                </div>
                <div class="sidebar-user">
                    <div class="sidebar-user-name" id="user-name">-</div>
                    <div class="sidebar-user-role">Sistem Y√∂neticisi</div>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li><a href="talepler.html" class="active"><span class="sidebar-menu-icon">üìù</span> Kayƒ±t Talepleri</a></li>
                <li><a href="dukkanlar.html"><span class="sidebar-menu-icon">üè™</span> D√ºkkanlar</a></li>
                <li><a href="#" onclick="logout(); return false;"><span class="sidebar-menu-icon">üö™</span> √áƒ±kƒ±≈ü</a></li>
            </ul>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1>Kayƒ±t Talepleri</h1>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="filterByStatus(null)">T√ºm√º</button>
                <button class="tab" onclick="filterByStatus(0)">Bekleyenler</button>
                <button class="tab" onclick="filterByStatus(1)">Onaylananlar</button>
                <button class="tab" onclick="filterByStatus(2)">Reddedilenler</button>
            </div>
            
            <!-- Talepler Listesi -->
            <div class="card">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Firma</th>
                                <th>Yetkili</th>
                                <th>Telefon</th>
                                <th>E-posta</th>
                                <th>Tarih</th>
                                <th>Durum</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="talepler-body">
                            <tr>
                                <td colspan="7" class="text-center">Y√ºkleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Cards -->
                <div class="mobile-cards" id="talepler-mobile"></div>
                
                <!-- Pagination -->
                <div id="pagination-container"></div>
            </div>
        </main>
    </div>
    
    <!-- Talep Detay Modal -->
    <div class="modal modal-lg" id="talep-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Talep Detayƒ±</h2>
                <button class="modal-close" onclick="closeModal('talep-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>Firma Bilgileri</h3>
                        <div class="detail-row">
                            <span class="detail-label">Firma Adƒ±</span>
                            <span class="detail-value" id="detay-firma-adi">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Telefon</span>
                            <span class="detail-value" id="detay-firma-telefon">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">E-posta</span>
                            <span class="detail-value" id="detay-firma-email">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Adres</span>
                            <span class="detail-value" id="detay-firma-adres">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vergi No</span>
                            <span class="detail-value" id="detay-vergi-no">-</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h3>Yetkili Bilgileri</h3>
                        <div class="detail-row">
                            <span class="detail-label">Ad Soyad</span>
                            <span class="detail-value" id="detay-yetkili-ad">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Telefon</span>
                            <span class="detail-value" id="detay-yetkili-telefon">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">E-posta</span>
                            <span class="detail-value" id="detay-yetkili-email">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Talep Tarihi</span>
                            <span class="detail-value" id="detay-tarih">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Durum</span>
                            <span class="detail-value" id="detay-durum">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Onay/Red i≈ülemleri (sadece bekleyenler i√ßin) -->
                <div id="islem-alani" style="display: none;">
                    <div class="divider"></div>
                    <div class="form-group">
                        <label for="islem-not">Not / A√ßƒ±klama</label>
                        <textarea id="islem-not" class="form-control" rows="3" placeholder="Onay veya red sebebi..."></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="onaylaTalep()">‚úì Onayla</button>
                        <button class="btn btn-danger" onclick="reddetTalep()">‚úï Reddet</button>
                    </div>
                </div>
                
                <!-- Onay/Red bilgisi (i≈ülem yapƒ±lmƒ±≈üsa) -->
                <div id="islem-sonucu" style="display: none;">
                    <div class="divider"></div>
                    <div class="detail-row">
                        <span class="detail-label">ƒ∞≈ülem Notu</span>
                        <span class="detail-value" id="detay-islem-notu">-</span>
                    </div>
                </div>
                
                <!-- Giri≈ü Bilgileri (onaylanmƒ±≈ü talep i√ßin) -->
                <div id="giris-bilgileri" style="display: none;">
                    <div class="divider"></div>
                    <h3 style="color: var(--accent); margin-bottom: 16px;">‚úÖ Olu≈üturulan Giri≈ü Bilgileri</h3>
                    <div class="detail-row" style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <span class="detail-label">Firma Kodu</span>
                        <span class="detail-value" id="detay-firma-kodu" style="font-family: monospace; font-weight: bold; color: var(--primary);">-</span>
                    </div>
                    <div class="detail-row" style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <span class="detail-label">E-posta</span>
                        <span class="detail-value" id="detay-giris-email">-</span>
                    </div>
                    <div class="detail-row" style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                        <span class="detail-label">≈ûifre</span>
                        <span class="detail-value" id="detay-sifre" style="font-family: monospace; font-weight: bold; color: var(--warning);">-</span>
                    </div>
                    <p style="margin-top: 12px; font-size: 13px; color: var(--text-muted);">
                        ‚ö†Ô∏è Bu bilgileri m√º≈üteriye iletin.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../../js/config.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/app.js"></script>
    <script>
        let currentPage = 1;
        let currentStatus = null;
        let selectedTalep = null;
        
        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireSuperAdmin()) return;
            initPage();
        });
        
        function initPage() {
            displayUserInfo();
            loadTalepler();
        }
        
        function displayUserInfo() {
            const user = Auth.getUser();
            if (user) {
                document.getElementById('user-name').textContent = user.adSoyad;
            }
        }
        
        // Duruma g√∂re filtrele
        function filterByStatus(status) {
            currentStatus = status;
            currentPage = 1;
            
            // Tab'larƒ± g√ºncelle
            document.querySelectorAll('.tab').forEach((tab, index) => {
                tab.classList.remove('active');
                if ((status === null && index === 0) ||
                    (status === 0 && index === 1) ||
                    (status === 1 && index === 2) ||
                    (status === 2 && index === 3)) {
                    tab.classList.add('active');
                }
            });
            
            loadTalepler();
        }
        
        // Talepleri y√ºkle
        async function loadTalepler(page = 1) {
            currentPage = page;
            
            const tbody = document.getElementById('talepler-body');
            const mobileContainer = document.getElementById('talepler-mobile');
            
            tbody.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div><p>Y√ºkleniyor...</p></div></td></tr>';
            
            try {
                const result = await AuthAPI.getTumTalepler(currentStatus, page, 20);
                
                if (!result?.success) {
                    tbody.innerHTML = '<tr><td colspan="7"><div class="alert alert-danger">Veriler y√ºklenemedi</div></td></tr>';
                    return;
                }
                
                const talepler = result.data.items || [];
                
                if (talepler.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üìù</div><h3>Talep bulunamadƒ±</h3></div></td></tr>';
                    mobileContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><h3>Talep bulunamadƒ±</h3></div>';
                    document.getElementById('pagination-container').innerHTML = '';
                    return;
                }
                
                // Tablo
                tbody.innerHTML = talepler.map(t => `
                    <tr>
                        <td><strong>${t.firmaAdi}</strong></td>
                        <td>${t.yetkiliAdSoyad}</td>
                        <td>${formatPhone(t.firmaTelefon)}</td>
                        <td>${t.firmaEmail}</td>
                        <td>${formatDate(t.talepTarihi)}</td>
                        <td>${getRequestStatusBadge(t.durum)}</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="showTalepDetay('${t.id}')">Detay</button>
                        </td>
                    </tr>
                `).join('');
                
                // Mobil kartlar
                mobileContainer.innerHTML = talepler.map(t => `
                    <div class="mobile-card">
                        <div class="mobile-card-header">
                            <span class="mobile-card-title">${t.firmaAdi}</span>
                            ${getRequestStatusBadge(t.durum)}
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Yetkili</span>
                            <span class="mobile-card-value">${t.yetkiliAdSoyad}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Telefon</span>
                            <span class="mobile-card-value">${formatPhone(t.firmaTelefon)}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Tarih</span>
                            <span class="mobile-card-value">${formatDate(t.talepTarihi)}</span>
                        </div>
                        <div class="mobile-card-actions">
                            <button class="btn btn-secondary" onclick="showTalepDetay('${t.id}')">Detay</button>
                        </div>
                    </div>
                `).join('');
                
                // Sayfalama
                const totalPages = result.data.totalPages || 1;
                document.getElementById('pagination-container').innerHTML = createPagination(currentPage, totalPages, 'loadTalepler');
                
            } catch (error) {
                console.error('Talepler y√ºklenirken hata:', error);
                tbody.innerHTML = '<tr><td colspan="7"><div class="alert alert-danger">Bir hata olu≈ütu</div></td></tr>';
            }
        }
        
        // Talep detayƒ±nƒ± g√∂ster
        async function showTalepDetay(id) {
            try {
                const result = await AuthAPI.getTalepById(id);
                
                if (!result?.success) {
                    showToast('Talep bulunamadƒ±', 'error');
                    return;
                }
                
                selectedTalep = result.data;
                const t = result.data;
                
                // Detaylarƒ± doldur
                document.getElementById('detay-firma-adi').textContent = t.firmaAdi;
                document.getElementById('detay-firma-telefon').textContent = formatPhone(t.firmaTelefon);
                document.getElementById('detay-firma-email').textContent = t.firmaEmail;
                document.getElementById('detay-firma-adres').textContent = t.firmaAdres || '-';
                document.getElementById('detay-vergi-no').textContent = t.vergiNo || '-';
                document.getElementById('detay-yetkili-ad').textContent = t.yetkiliAdSoyad;
                document.getElementById('detay-yetkili-telefon').textContent = formatPhone(t.yetkiliTelefon);
                document.getElementById('detay-yetkili-email').textContent = t.yetkiliEmail;
                document.getElementById('detay-tarih').textContent = formatDateTime(t.talepTarihi);
                document.getElementById('detay-durum').innerHTML = getRequestStatusBadge(t.durum);
                
                // Bekleyen talep ise i≈ülem alanƒ±nƒ± g√∂ster
                if (t.durum === 0) {
                    document.getElementById('islem-alani').style.display = 'block';
                    document.getElementById('islem-sonucu').style.display = 'none';
                    document.getElementById('giris-bilgileri').style.display = 'none';
                    document.getElementById('islem-not').value = '';
                } else {
                    document.getElementById('islem-alani').style.display = 'none';
                    document.getElementById('islem-sonucu').style.display = 'block';
                    document.getElementById('detay-islem-notu').textContent = t.notlar || t.redNedeni || '-';
                    
                    // Onaylanmƒ±≈ü ise giri≈ü bilgilerini g√∂ster
                    if (t.durum === 1 && t.olusturulanFirmaKodu) {
                        document.getElementById('giris-bilgileri').style.display = 'block';
                        document.getElementById('detay-firma-kodu').textContent = t.olusturulanFirmaKodu;
                        document.getElementById('detay-giris-email').textContent = t.yetkiliEmail;
                        document.getElementById('detay-sifre').textContent = t.olusturulanSifre || '-';
                    } else {
                        document.getElementById('giris-bilgileri').style.display = 'none';
                    }
                }
                
                openModal('talep-modal');
                
            } catch (error) {
                showToast('Bir hata olu≈ütu', 'error');
            }
        }
        
        // Talep onayla
        async function onaylaTalep() {
            if (!selectedTalep) return;
            if (!confirmAction('Bu talebi onaylamak istediƒüinize emin misiniz?')) return;
            
            try {
                const notlar = document.getElementById('islem-not').value;
                const result = await AuthAPI.talepOnayla(selectedTalep.id, notlar);
                
                if (result?.success) {
                    showToast('Talep onaylandƒ±!', 'success');
                    closeModal('talep-modal');
                    loadTalepler(currentPage);
                } else {
                    showToast(result?.errors?.[0] || result?.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error');
                }
            } catch (error) {
                showToast('Bir hata olu≈ütu', 'error');
            }
        }
        
        // Talep reddet
        async function reddetTalep() {
            if (!selectedTalep) return;
            
            const redNedeni = document.getElementById('islem-not').value;
            if (!redNedeni.trim()) {
                showToast('Red sebebi girmelisiniz', 'error');
                return;
            }
            
            if (!confirmAction('Bu talebi reddetmek istediƒüinize emin misiniz?')) return;
            
            try {
                const result = await AuthAPI.talepReddet(selectedTalep.id, redNedeni);
                
                if (result?.success) {
                    showToast('Talep reddedildi', 'success');
                    closeModal('talep-modal');
                    loadTalepler(currentPage);
                } else {
                    showToast(result?.errors?.[0] || result?.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error');
                }
            } catch (error) {
                showToast('Bir hata olu≈ütu', 'error');
            }
        }
    </script>
</body>
</html>